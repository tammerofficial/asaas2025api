#!/bin/bash

# =============================================================================
# ๐ ุณูุฑูุจุช ุฅุตูุงุญ ุฃุฏุงุก ุงูุฏุงุดุจูุฑุฏ - asaas.local
# =============================================================================
# ุงูุงุณุชุฎุฏุงู: ./FIX_DASHBOARD_PERFORMANCE.sh
# =============================================================================

set -e  # Exit on error

echo "========================================="
echo "๐ ุจุฏุก ุนูููุฉ ุชุญุณูู ุฃุฏุงุก ุงูุฏุงุดุจูุฑุฏ"
echo "========================================="
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# =============================================================================
# 1. ูุญุต ุงููุดููุฉ ุงูุญุงููุฉ
# =============================================================================
echo "1๏ธโฃ ูุญุต ุงููุดููุฉ ุงูุญุงููุฉ..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โฑ๏ธ  ููุงุณ ุงูููุช ุงูุญุงูู..."
BEFORE_TIME=$(curl -k -w "%{time_total}" -o /dev/null -s https://asaas.local/admin-home 2>&1)
echo -e "${RED}โฐ ุงูููุช ุงูุญุงูู: ${BEFORE_TIME}s${NC}"
echo ""

# =============================================================================
# 2. ุงูุชุญูู ูู /etc/hosts
# =============================================================================
echo "2๏ธโฃ ูุญุต ูุฅุตูุงุญ /etc/hosts..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if grep -q "^127.0.0.1.*asaas.local" /etc/hosts; then
    echo "โ asaas.local ููุฌูุฏ ูู /etc/hosts"
else
    echo "โ๏ธ  asaas.local ุบูุฑ ููุฌูุฏ ูู /etc/hosts"
    echo "๐ก ูุฑุฌู ุชุดุบูู ูุฐุง ุงูุฃูุฑ ูุฏููุงู:"
    echo -e "${YELLOW}sudo sh -c 'echo \"127.0.0.1 asaas.local alalawi310.asaas.local\" >> /etc/hosts'${NC}"
fi
echo ""

# =============================================================================
# 3. ุชุนุทูู Debug Mode
# =============================================================================
echo "3๏ธโฃ ุชุนุทูู Debug Mode..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
cd core

if grep -q "APP_DEBUG=true" .env; then
    echo "โ๏ธ  Debug Mode ููุนูุ ุฌุงุฑู ุงูุชุนุทูู..."
    
    # Backup .env
    cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
    echo "โ ุชู ุนูู backup ููู .env"
    
    # ุชุนุทูู Debug
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        sed -i '' 's/APP_DEBUG=true/APP_DEBUG=false/' .env
    else
        # Linux
        sed -i 's/APP_DEBUG=true/APP_DEBUG=false/' .env
    fi
    echo "โ ุชู ุชุนุทูู Debug Mode"
else
    echo "โ Debug Mode ูุนุทู ุจุงููุนู"
fi
echo ""

# =============================================================================
# 4. ุชูุธูู ุงููุงุด
# =============================================================================
echo "4๏ธโฃ ุชูุธูู ุงููุงุด..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
php artisan optimize:clear
echo "โ ุชู ุชูุธูู ุฌููุน ุฃููุงุน ุงููุงุด"
echo ""

# =============================================================================
# 5. ุชุญุณูู Config
# =============================================================================
echo "5๏ธโฃ ุชุญุณูู Config Cache..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if php artisan config:cache 2>&1; then
    echo "โ ุชู ุนูู config cache"
else
    echo "โ๏ธ  ูู ูุชู ุนูู config cache (ูุฏ ูููู ููุงู ูุดุงูู ูู config)"
fi
echo ""

# =============================================================================
# 6. ูุญุงููุฉ ุฅุตูุงุญ Routes
# =============================================================================
echo "6๏ธโฃ ูุญุต Routes..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุงูุจุญุซ ุนู routes ุงููุชุถุงุฑุจุฉ
echo "๐ ุงูุจุญุซ ุนู ุชุถุงุฑุจ ูู ุฃุณูุงุก Routes..."
CONFLICTS=$(grep -r "->name('orders.index')" routes/ Modules/ 2>/dev/null | wc -l)

if [ $CONFLICTS -gt 1 ]; then
    echo -e "${YELLOW}โ๏ธ  ุชู ุงูุชุดุงู ุชุถุงุฑุจ ูู ุฃุณูุงุก Routes ($CONFLICTS ูุฑุฉ)${NC}"
    echo "๐ ูุฑุฌู ุฅุตูุงุญ ุงูุชุถุงุฑุจ ูุฏููุงู ูู:"
    grep -r "->name('orders.index')" routes/ Modules/ 2>/dev/null || true
    echo ""
    echo "๐ก ูููุตุญ ุจุชุบููุฑ ุฃุณูุงุก routes ูู API ุฅูู:"
    echo "   ->names('api.orders')"
else
    echo "โ ูุง ููุฌุฏ ุชุถุงุฑุจ ูุงุถุญ ูู Routes"
    
    # ูุญุงููุฉ ุนูู route cache
    echo "ูุญุงููุฉ ุนูู route cache..."
    if php artisan route:cache 2>&1; then
        echo "โ ุชู ุนูู route cache ุจูุฌุงุญ"
    else
        echo -e "${YELLOW}โ๏ธ  ูู ูุชู ุนูู route cache (ููุฌุฏ ุชุถุงุฑุจ)${NC}"
        php artisan route:clear
    fi
fi
echo ""

# =============================================================================
# 7. ุชุญุณูู ุงุณุชุนูุงูุงุช Database
# =============================================================================
echo "7๏ธโฃ ูุญุต ุฃุฏุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

php artisan tinker --execute="
use Illuminate\Support\Facades\DB;
DB::enableQueryLog();

\$start = microtime(true);

// Simulate dashboard queries
\$total_admin = \App\Models\Admin::count();
\$total_user = \App\Models\User::count();
\$all_tenants = \App\Models\Tenant::whereValid()->count();
\$total_price_plan = \App\Models\PricePlan::count();
\$total_brand = \App\Models\Brand::count();
\$total_testimonial = \App\Models\Testimonial::count();
\$recent_order_logs = \App\Models\PaymentLogs::orderBy('id','desc')->take(5)->get();

\$totalTime = microtime(true) - \$start;
\$queryCount = count(DB::getQueryLog());

echo 'โ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช:' . PHP_EOL;
echo '   - ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช: ' . \$queryCount . PHP_EOL;
echo '   - ุงูููุช ุงูุฅุฌูุงูู: ' . round(\$totalTime * 1000, 2) . 'ms' . PHP_EOL;

if (\$totalTime * 1000 < 15) {
    echo '   โ ุงูุฃุฏุงุก ููุชุงุฒ!' . PHP_EOL;
} elseif (\$totalTime * 1000 < 50) {
    echo '   โ๏ธ  ุงูุฃุฏุงุก ุฌูุฏ (ูููู ุชุญุณููู)' . PHP_EOL;
} else {
    echo '   โ๏ธ  ุงูุฃุฏุงุก ุจุทูุก (ูุญุชุงุฌ ุชุญุณูู)' . PHP_EOL;
}
"
echo ""

# =============================================================================
# 8. ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก ุจุนุฏ ุงูุชุญุณูู
# =============================================================================
echo "8๏ธโฃ ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก ุจุนุฏ ุงูุชุญุณูู..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุงุฎุชุจุงุฑ ูุชุนุฏุฏ
echo "๐ ุชุดุบูู 3 ุงุฎุชุจุงุฑุงุช..."
TOTAL_TIME=0
for i in {1..3}; do
    TIME=$(curl -k -w "%{time_total}" -o /dev/null -s https://asaas.local/admin-home 2>&1)
    echo "   ุงูุงุฎุชุจุงุฑ #$i: ${TIME}s"
    TOTAL_TIME=$(echo "$TOTAL_TIME + $TIME" | bc)
done

AVERAGE_TIME=$(echo "scale=3; $TOTAL_TIME / 3" | bc)
echo ""
echo -e "๐ ูุชูุณุท ุงูููุช: ${GREEN}${AVERAGE_TIME}s${NC}"

# ููุงุฑูุฉ
echo ""
echo "๐ ุงูููุงุฑูุฉ:"
echo -e "   ูุจู: ${RED}${BEFORE_TIME}s${NC}"
echo -e "   ุจุนุฏ: ${GREEN}${AVERAGE_TIME}s${NC}"

IMPROVEMENT=$(echo "scale=1; (1 - $AVERAGE_TIME / $BEFORE_TIME) * 100" | bc)
if (( $(echo "$IMPROVEMENT > 0" | bc -l) )); then
    echo -e "   ${GREEN}โ ุชุญุณู ุจูุณุจุฉ: ${IMPROVEMENT}%${NC}"
else
    echo -e "   ${RED}โ๏ธ  ูู ูุญุฏุซ ุชุญุณู ููุญูุธ${NC}"
fi

cd ..
echo ""

# =============================================================================
# 9. ุชูุตูุงุช ุฅุถุงููุฉ
# =============================================================================
echo "9๏ธโฃ ุชูุตูุงุช ุฅุถุงููุฉ..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if (( $(echo "$AVERAGE_TIME > 1" | bc -l) )); then
    echo -e "${YELLOW}โ๏ธ  ุงูููุช ูุง ุฒุงู ุจุทูุฆุงู (> 1s)${NC}"
    echo ""
    echo "๐ก ุชูุตูุงุช:"
    echo ""
    echo "   1. ุชุญูู ูู ุฅุนุฏุงุฏุงุช DNS ูู ServBay:"
    echo "      - ุงูุชุญ ServBay โ Settings โ DNS"
    echo "      - ููู timeout ุฅูู minimum"
    echo "      - ุฃู ุงุณุชุฎุฏู System DNS"
    echo ""
    echo "   2. ุฅุถุงูุฉ asaas.local ูู /etc/hosts ูุฏููุงู:"
    echo -e "      ${YELLOW}sudo nano /etc/hosts${NC}"
    echo "      ุฃุถู: 127.0.0.1 asaas.local"
    echo ""
    echo "   3. ุฅุนุงุฏุฉ ุชุดุบูู ServBay:"
    echo "      - ุฃููู ServBay"
    echo "      - ุงูุชุธุฑ 5 ุซูุงูู"
    echo "      - ุดุบูู ServBay"
    echo ""
    echo "   4. ุงุฎุชุจุงุฑ ูู IP ูุจุงุดุฑุฉ:"
    echo "      https://127.0.0.1/admin-home"
    echo ""
else
    echo -e "${GREEN}โ ุงูุฃุฏุงุก ููุชุงุฒ! (< 1s)${NC}"
fi

echo ""
echo "========================================="
echo "โ ุงูุชูุช ุนูููุฉ ุงูุชุญุณูู"
echo "========================================="
echo ""
echo "๐ ุงููููุงุช ุงููููุดุฃุฉ:"
echo "   - .env.backup.* (ูุณุฎุฉ ุงุญุชูุงุทูุฉ)"
echo ""
echo "๐ ุงูุชูุฑูุฑ ุงููุงูู:"
echo "   DASHBOARD_PERFORMANCE_REPORT.md"
echo ""
echo "๐งช ููุงุฎุชุจุงุฑ ุงูููุงุฆู:"
echo "   1. ุงูุชุญ ุงููุชุตูุญ"
echo "   2. ุงุฐูุจ ุฅูู: https://asaas.local/admin-home"
echo "   3. ูุงุญุธ ุณุฑุนุฉ ุงูุชุญููู"
echo ""

